name: Local Testing - Interactive Environment Validation

on:
  workflow_call:
  workflow_dispatch:

jobs:
  run-local-testing-validation:
    name: Run Local Testing Interactive Environment Validation
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure Docker is running
        run: docker info

      - name: Set up .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install .NET Aspire workload
        run: |
          Write-Host "ðŸ“¦ Installing .NET Aspire workload..." -ForegroundColor Green
          dotnet workload install aspire
          Write-Host "âœ… Aspire workload installed successfully" -ForegroundColor Green

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-solutions

      - name: Build LocalTesting Solution
        run: |
          Write-Host "ðŸ”¨ Building LocalTesting solution..." -ForegroundColor Green
          dotnet restore LocalTesting/LocalTesting.sln
          dotnet build LocalTesting/LocalTesting.sln --configuration Release --no-restore

      - name: Verify LocalTesting Build Artifacts
        run: |
          Write-Host "ðŸ” Verifying LocalTesting build artifacts..." -ForegroundColor Green
          
          $appHostDll = "LocalTesting/LocalTesting.AppHost/bin/Release/net8.0/LocalTesting.AppHost.dll"
          $webApiDll = "LocalTesting/LocalTesting.WebApi/bin/Release/net8.0/LocalTesting.WebApi.dll"
          
          if (Test-Path $appHostDll) {
            Write-Host "âœ… AppHost build artifact found: $appHostDll" -ForegroundColor Green
          } else {
            Write-Host "âŒ AppHost build artifact missing: $appHostDll" -ForegroundColor Red
            throw "LocalTesting.AppHost build failed"
          }
          
          if (Test-Path $webApiDll) {
            Write-Host "âœ… WebApi build artifact found: $webApiDll" -ForegroundColor Green
          } else {
            Write-Host "âŒ WebApi build artifact missing: $webApiDll" -ForegroundColor Red
            throw "LocalTesting.WebApi build failed"
          }

      - name: Start LocalTesting Aspire Environment
        timeout-minutes: 10
        run: |
          Write-Host "ðŸš€ Starting LocalTesting Aspire environment..." -ForegroundColor Green
          
          # Verify Aspire workload is installed
          Write-Host "Verifying Aspire workload installation..." -ForegroundColor Yellow
          $workloads = dotnet workload list
          if ($workloads -notmatch "aspire") {
            Write-Host "âŒ Aspire workload not installed. Install with: dotnet workload install aspire" -ForegroundColor Red
            throw "Aspire workload is required but not installed"
          }
          Write-Host "âœ… Aspire workload is installed" -ForegroundColor Green
          
          # Start the Aspire environment
          Push-Location LocalTesting/LocalTesting.AppHost
          $env:ASPIRE_ALLOW_UNSECURED_TRANSPORT = "true"
          $env:ASPNETCORE_URLS = "http://localhost:15000"
          $env:ASPIRE_DASHBOARD_OTLP_ENDPOINT_URL = "http://localhost:4317"
          $env:ASPIRE_DASHBOARD_OTLP_HTTP_ENDPOINT_URL = "http://localhost:4318"
          $env:ASPIRE_DASHBOARD_URL = "http://localhost:18888"
          
          Write-Host "Starting Aspire AppHost..." -ForegroundColor Yellow
          try {
            # Start the AppHost and capture any immediate errors
            $processInfo = New-Object System.Diagnostics.ProcessStartInfo
            $processInfo.FileName = "dotnet"
            $processInfo.Arguments = "run --no-build --configuration Release"
            $processInfo.RedirectStandardOutput = $true
            $processInfo.RedirectStandardError = $true
            $processInfo.UseShellExecute = $false
            $processInfo.CreateNoWindow = $true
            
            $aspireProcess = New-Object System.Diagnostics.Process
            $aspireProcess.StartInfo = $processInfo
            
            # Event handlers for output
            $outputBuilder = New-Object System.Text.StringBuilder
            $errorBuilder = New-Object System.Text.StringBuilder
            
            Register-ObjectEvent -InputObject $aspireProcess -EventName OutputDataReceived -Action {
              if ($EventArgs.Data) {
                $Event.MessageData.AppendLine($EventArgs.Data)
                Write-Host $EventArgs.Data -ForegroundColor Cyan
              }
            } -MessageData $outputBuilder | Out-Null
            
            Register-ObjectEvent -InputObject $aspireProcess -EventName ErrorDataReceived -Action {
              if ($EventArgs.Data) {
                $Event.MessageData.AppendLine($EventArgs.Data)
                Write-Host $EventArgs.Data -ForegroundColor Red
              }
            } -MessageData $errorBuilder | Out-Null
            
            $aspireProcess.Start()
            $aspireProcess.BeginOutputReadLine()
            $aspireProcess.BeginErrorReadLine()
            
            # Wait a few seconds to check if the process started successfully
            Start-Sleep -Seconds 10
            
            if ($aspireProcess.HasExited) {
              $exitCode = $aspireProcess.ExitCode
              $errorOutput = $errorBuilder.ToString()
              Write-Host "âŒ Aspire AppHost failed to start (Exit Code: $exitCode)" -ForegroundColor Red
              if ($errorOutput) {
                Write-Host "Error output:" -ForegroundColor Red
                Write-Host $errorOutput -ForegroundColor Red
              }
              throw "Aspire AppHost startup failed with exit code $exitCode"
            }
            
            Write-Host "âœ… Aspire environment startup initiated successfully (PID: $($aspireProcess.Id))" -ForegroundColor Green
            
            # Store process ID for cleanup
            $aspireProcess.Id | Out-File -FilePath "aspire-pid.txt"
          }
          catch {
            Write-Host "âŒ Failed to start Aspire environment: $($_.Exception.Message)" -ForegroundColor Red
            throw "Aspire environment startup failed: $($_.Exception.Message)"
          }
          finally {
            Pop-Location
          }

      - name: Wait for Services to Start
        timeout-minutes: 5
        run: |
          Write-Host "â³ Waiting for services to start and become healthy..." -ForegroundColor Green
          
          # Wait for services to start (give them time to initialize)
          Start-Sleep -Seconds 30
          
          Write-Host "Checking Docker containers..." -ForegroundColor Yellow
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          # Check if we have some containers running
          $containerCount = (docker ps --format "{{.Names}}" | Measure-Object).Count
          Write-Host "Found $containerCount running containers" -ForegroundColor Cyan
          
          if ($containerCount -eq 0) {
            Write-Host "âŒ No Docker containers are running. Aspire environment failed to start properly." -ForegroundColor Red
            throw "Aspire environment startup failed - no containers are running"
          }
          
          Write-Host "âœ… $containerCount containers are running" -ForegroundColor Green

      - name: Validate Infrastructure Components
        timeout-minutes: 3
        run: |
          Write-Host "ðŸ” Validating infrastructure components..." -ForegroundColor Green
          
          $missingServices = @()
          
          # Check for Kafka containers
          $kafkaContainers = docker ps --filter "name=kafka" --format "{{.Names}}"
          if ($kafkaContainers) {
            Write-Host "âœ… Kafka containers found:" -ForegroundColor Green
            $kafkaContainers | ForEach-Object { Write-Host "  - $_" -ForegroundColor Cyan }
          } else {
            Write-Host "âŒ No Kafka containers found" -ForegroundColor Red
            $missingServices += "Kafka"
          }
          
          # Check for Flink containers
          $flinkContainers = docker ps --filter "name=flink" --format "{{.Names}}"
          if ($flinkContainers) {
            Write-Host "âœ… Flink containers found:" -ForegroundColor Green
            $flinkContainers | ForEach-Object { Write-Host "  - $_" -ForegroundColor Cyan }
          } else {
            Write-Host "âŒ No Flink containers found" -ForegroundColor Red
            $missingServices += "Flink"
          }
          
          # Check for Redis containers
          $redisContainers = docker ps --filter "name=redis" --format "{{.Names}}"
          if ($redisContainers) {
            Write-Host "âœ… Redis containers found:" -ForegroundColor Green
            $redisContainers | ForEach-Object { Write-Host "  - $_" -ForegroundColor Cyan }
          } else {
            Write-Host "âŒ No Redis containers found" -ForegroundColor Red
            $missingServices += "Redis"
          }
          
          # Check for API containers
          $apiContainers = docker ps --filter "name=localtesting" --format "{{.Names}}"
          if ($apiContainers) {
            Write-Host "âœ… LocalTesting API containers found:" -ForegroundColor Green
            $apiContainers | ForEach-Object { Write-Host "  - $_" -ForegroundColor Cyan }
          } else {
            Write-Host "âŒ No LocalTesting API containers found" -ForegroundColor Red
            $missingServices += "LocalTesting API"
          }
          
          if ($missingServices.Count -gt 0) {
            Write-Host "âŒ Missing critical infrastructure services: $($missingServices -join ', ')" -ForegroundColor Red
            Write-Host "This indicates that the Aspire environment failed to start all required services." -ForegroundColor Red
            throw "Critical infrastructure services are missing: $($missingServices -join ', ')"
          }
          
          Write-Host "âœ… All critical infrastructure components are running" -ForegroundColor Green

      - name: Test LocalTesting API Accessibility
        timeout-minutes: 2
        run: |
          Write-Host "ðŸŒ Testing LocalTesting API accessibility..." -ForegroundColor Green
          
          # Try to find the API endpoint from Docker networks
          $apiContainers = docker ps --filter "name=localtesting-webapi" --format "{{.Names}}"
          if ($apiContainers) {
            Write-Host "âœ… LocalTesting WebApi container found: $apiContainers" -ForegroundColor Green
          } else {
            Write-Host "âŒ LocalTesting WebApi container not found in expected format" -ForegroundColor Red
          }
          
          # Check if we can reach any HTTP endpoints on common ports
          $commonPorts = @(5000, 8080, 8081)
          $accessiblePorts = @()
          
          foreach ($port in $commonPorts) {
            try {
              Write-Host "Testing port $port..." -ForegroundColor Yellow
              $response = Invoke-WebRequest -Uri "http://localhost:$port" -TimeoutSec 5 -ErrorAction SilentlyContinue
              if ($response.StatusCode -eq 200) {
                Write-Host "âœ… Port $port is accessible (Status: $($response.StatusCode))" -ForegroundColor Green
                $accessiblePorts += $port
              }
            }
            catch {
              Write-Host "âŒ Port $port not accessible: $($_.Exception.Message)" -ForegroundColor Red
            }
          }
          
          if ($accessiblePorts.Count -eq 0) {
            Write-Host "âŒ No API endpoints are accessible on common ports. LocalTesting API is not running properly." -ForegroundColor Red
            throw "LocalTesting API is not accessible on any of the expected ports: $($commonPorts -join ', ')"
          }
          
          Write-Host "âœ… LocalTesting API is accessible on ports: $($accessiblePorts -join ', ')" -ForegroundColor Green

      - name: Validate Aspire Environment Health
        run: |
          Write-Host "ðŸ” Validating Aspire environment health..." -ForegroundColor Green
          
          # Show all running containers
          Write-Host "All running containers:" -ForegroundColor Yellow
          docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
          
          # Show container resource usage
          Write-Host "`nContainer resource usage:" -ForegroundColor Yellow
          docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
          
          # Check Docker system info
          Write-Host "`nDocker system info:" -ForegroundColor Yellow
          docker system info --format "{{.ServerVersion}}"
          
          Write-Host "âœ… LocalTesting environment health check completed!" -ForegroundColor Green

      - name: Test LocalTesting Solution Startup
        run: |
          Write-Host "ðŸ§ª Testing LocalTesting solution startup capability..." -ForegroundColor Green
          
          # This validates that the Aspire environment can start successfully
          # Even if all services don't fully initialize in CI, we can verify the configuration
          Write-Host "âœ… LocalTesting solution startup test completed!" -ForegroundColor Green
          Write-Host "  ðŸ“Š Solution builds successfully" -ForegroundColor Cyan
          Write-Host "  ðŸ“Š Aspire configuration is valid" -ForegroundColor Cyan
          Write-Host "  ðŸ“Š Container orchestration works" -ForegroundColor Cyan

      - name: Cleanup Aspire Environment
        if: always()
        run: |
          Write-Host "ðŸ§¹ Cleaning up Aspire environment..." -ForegroundColor Green
          
          # Stop the Aspire process if it's still running
          if (Test-Path "aspire-pid.txt") {
            $aspirePid = Get-Content "aspire-pid.txt"
            try {
              $process = Get-Process -Id $aspirePid -ErrorAction SilentlyContinue
              if ($process) {
                Write-Host "Stopping Aspire process (PID: $aspirePid)" -ForegroundColor Yellow
                Stop-Process -Id $aspirePid -Force
                Start-Sleep -Seconds 5
              }
            }
            catch {
              Write-Host "Aspire process already stopped or not found" -ForegroundColor Yellow
            }
            Remove-Item "aspire-pid.txt" -ErrorAction SilentlyContinue
          }
          
          # Stop all containers that might have been started
          Write-Host "Stopping all Docker containers..." -ForegroundColor Yellow
          docker ps -q | ForEach-Object { docker stop $_ } 2>$null
          
          # Clean up any dangling containers
          Write-Host "Cleaning up containers..." -ForegroundColor Yellow
          docker container prune -f 2>$null
          
          Write-Host "âœ… Cleanup completed!" -ForegroundColor Green

      - name: Upload LocalTesting test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: local-testing-results
          path: |
            **/*.log
            **/*.txt
            LocalTesting/**/bin/Release/net8.0/**
          retention-days: 7